# 챕터2: 생성자, 소멸자 및 대입 연산자

## 항목 7: 다형성을 가진 기본 클래스에서는 소멸자를 반드시 가상 소멸자로 선언하자

TimeKeeper라는 클래스를 기본 클래스로 만들고, 이를 파생시켜 다형성을 이용하는 경우가 있다고 해보자.

```cpp
class TimeKeeper {
public:
	TimeKeeper();
	~TimeKeeper();
	...
};
class AtomicClock: public TimeKeeper { ... };
class WaterClock: public TimeKeeper { ... };
class WristClock: public TimeKeeper { ... };
```

TimeKeeper의 파생 클래스들은 TimeKeeper의 다형성을 이용하는 것이므로, 기본 클래스 포인터를 반환하는 팩토리 함수를 만들어 이용하면 좋을 것 같다.

```cpp
TimeKeeper* getTimeKeeper(); // 파생된 클래스 객체를 TimeKeeper 포인터로 동적 할당해 반환
```

이대로 이용하게 되면, 이 함수에서 반환되는 객체는 동적할당된 객체이므로, 힙 영역에 저장이 된다. 따라서 이를 사용한 후에는 적절히 delete하는 과정이 필수적이다. 하지만 이를 그냥 delete하게 되면, 파생 클래스 객체의 소멸자는 제대로 실행되지 않는다.

C++ 규정에 의하면, 기본 클래스 포인터를 통해 파생 클래스 객체가 삭제될 때 그 기본 클래스의 소멸자가 비가상, 즉 virtual이 아니라면 프로그램 동작은 미정의 사항이라고 되어 있다. 한번 천천히 생각해보자. 다형성을 가지는 나머지 동작들은 모두 가상 함수로 선언이 되어 있을 것이다. 따라서 소멸자도 다형성을 가져야 하는데, 이것만 비가상 함수로 되어 있는 것이다. 이때 어떤 동작을 해야 하는지는 **미정의(undefined behavior)**되어 있다고 한다. 보통은 기본 클래스 객체만 올바르게 소멸되고, 파생 클래스 부분은 제대로 처리가 되지 않는다고 한다.

따라서 우리는 기본 클래스에게 가상 소멸자를 정의해줘야 한다. 가상 소멸자를 가진 기본 클래스는, 소멸될 때 올바르게 파생 클래스 부분도 소멸시킨다. 우리는 이제 가상 함수를 하나라도 가진 클래스라면 가상 소멸자를 쥐어줘야한다.

물론 그렇다고 모든 클래스에 가상 소멸자를 막 쥐어주는 것은 좋지 못하다. 다음의 클래스를 보자.

```cpp
class Point {
public:
	Point(int xCoord, int yCoord);
	~Point();
	
private:
	int x, y;
};
```

다음은 int형 멤버가 두 개 있고, 가상 소멸자가 선언된 클래스 Point다. int 하나가 32비트를 차지한다고 가정하면, 이 Point의 객체는 64비트의 크기라고 생각할 수 있다. 하지만 아니다. 가상 함수의 포인터가 존재해야하기 때문이다.

가상 함수를 C++에서 구현하려면 클래스에 별도의 자료구조가 들어가야 한다. 이 자료구조는 주어진 객체에 대해 어떤 가상 함수를 호출해야 하는지 결정하는 데에 쓰인다. 보통 vptr(virtual table pointer)라는 이름으로 불리고, 이것은 가상 함수의 주소, vtbl(virtual table)을 가리킨다. 결국 Point 객체에서 가상 소멸자가 호출되려면, 그 객체의 vptr이 가리키는 vtbl에 따라 정확한 행동이 결정되는 것이다.

따라서 경우 없이 전부 가상 소멸자를 선언하는 것은 옳지 못하다. 클래스에 가상 함수가 하나라도 있는 경우에만 가상 소멸자를 선언하도록 하자.

추상 클래스를 만들고 싶은데, 딱히 쥐어줄만한 순수 가상 함수가 없을 경우에는 순수 가상 소멸자가 답이 된다. 억지로 다른 함수를 순수 가상 함수로 만들지 말고, 소멸자를 순수 가상 소멸자로 만들자. 물론 이 순수 가상 소멸자는 반드시 정의가 필요하다는 걸 기억하자.

```cpp
class AWOV {
public:
	virtual ~AWOV() = 0;
};
AWOV::~AWOV() {} // 정의
```

소멸자는 파생 클래스 > 기본 클래스 순으로 하나씩 호출이 되기 때문에, 본문이 꼭 필요하다는 걸 기억하자.

모든 기본 클래스가 다형성을 갖도록 설계된 것은 아니다. 표준 string 타입, STL 컨테이너 타입 등은 다형성의 흔적도 없고, 소멸자가 가상인 것도 아니다. 이들을 통해 파생 클래스를 만들어 제대로 소멸되지 않는 상황을 유의하자.

> 다형성을 가진 기본 클래스에는 반드시 가상 소멸자를 선언해야 한다.
> 기본 클래스로 설계되지 않거나 다형성을 갖도록 설계되지 않은 클래스에는 가상 소멸자를 선언하지 말아야 한다.