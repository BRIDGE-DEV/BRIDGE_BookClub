## 항목 7: 다형성을 가진 기본 클래스에서는 소멸자를 반드시 가상 소멸자로 선언하자
<br>

### 다형성을 가진 기본 클래스에서의 소멸자
**팩토리 함수**란 새로 생성된 파생 클래스 객체에 대한 기본 클래스 포인터를 반환하는 함수이다.
팩토리 함수에서 반환되는 객체는 힙에 있게 되므로, 메모리 및 기타 자원의 누출을 막기 위해 해당 객체를 삭제해야 한다.

> #### 문제점
팩토리 함수가 반환하는 포인터는 파생 클래스 객체에 대한 포인터이다.
기본 클래스 포인터를 통해 파생 클래스 객체가 삭제되고
기본 클래스에 들어있는 소멸자는 **비가상 소멸자**이다.
<br> 위와 같은 경우, C++ 규정에 의해 대개 **객체의 파생 클래스 부분이 소멸되지 않는다.** 또한, **파생 클래스의 소멸자도 실행되지 않는다.**
그러나, 기본 클래스 부분의 소멸 과정은 제대로 끝나므로 **부분 소멸 객체**가 된다.

> #### 해결
기본 클래스의 소멸자를 **가상 소멸자**로 만들면 해결된다.
기본 클래스의 소멸자에 **virtual**을 붙여주면 가상 소멸자가 된다.
```cpp
virtual ~TimeKeeper();
```
가상 함수를 하나라도 가진 클래스는 가상 소멸자를 가져야 한다.

<br>

### 가상 소멸자는 가상 함수가 있을 때 사용하기
**vptr(가상 함수 테이블 포인터)**는 **가상 함수의 주소**, 즉 **포인터들의 배열**을 가리키고 있다. 프로그램 실행 중에 주어진 객체에 대해 어떤 가상 함수를 호출해야 하는지를 결정한다.
**vtbl(가상 함수 테이블)**은 **가상 함수 테이블 포인터의 배열**이다. 가상 함수를 하나라도 갖는 클래스는 반드시 그와 관련된 vtbl을 갖고 있다.
가상 함수가 호출되려고 하면, 호출되는 실제 함수는 **그 객체의 vptr이 가리키는 vtbl에 따라 결정된다.**

클래스에 가상 함수가 추가되면 가상 함수 테이블 포인터(vptr)가 추가되어 객체의 크기가 커진다. (아키텍처에 따라 32비트 또는 64비트+)
이로 인해 다른 언어와의 호환성, 이식성이 없어진다.
따라서, **가상 소멸자는 가상 함수가 하나라도 있는 경우에만 사용해야 한다.**

<br>


### 가상 소멸자가 없는 클래스를 기본 클래스로 만들지 말자
가상 함수가 없음에도 비가상 소멸자 때문에 문제가 발생하는 경우가 있다.
```cpp
class SpecialString: public std::string{	// string 타입을 기본 클래스로 잡아버렸다.
...
};
```
```cpp
SpecialString *pss = new SpecialString("Impending Doom");
std::string *ps;
...
ps = pss;	// SpecialString* => std::string*
...
delete ps;	// 정의되지 않은 동작 발생. SpecialString 소멸자가 호출되지 않아, 실질적으로는 *ps의 자원이 누출됨
```
이 현상은 string, STL 컨테이너 타입 등 가상 소멸자가 없는 클래스이면 어떤 것에든 적용된다.

<br>

### 순수 가상 소멸자
**추상 클래스**는 **그 자체로 인스턴스를 못 만드는 클래스**이다.
추상 클래스는 본래 **기본 클래스로 쓰일 목적으로 만들어지고,** 기본 클래스로 사용하려는 클래스는 가상 소멸자를 가져야 한다.
순수 가상 함수가 있으면 해당 클래스를 추상 클래스가 된다.
=> 즉, 추상 클래스로 만들고 싶은 클래스에 순수 가상 소멸자(= 순수 가상 함수)를 선언하면 된다.
```cpp
class AWOV{
public:
	virtual ~AWOV() = 0;
};
```
가장 말단에 있는 파생 클래스의 소멸자가 먼저 호출되고, 기본 클래스 쪽으로 올라가면서 각 기본 클래스의 소멸자가 하나씩 호출된다.
따라서, **순수 가상 소멸자의 정의를 두어야 한다.**
```cpp
AWOV::~AWOV() {}
```

**'기본 클래스의 소멸자를 가상 소멸자로 만들자'**는 규칙은 **다형성을 가진 기본 클래스**에만 적용된다.
즉, 기본 클래스 인터페이스를 통해 파생 클래스 타입의 조작을 허용하도록 설계된 기본 클래스에만 적용된다.
<br>

<br>

- **다형성을 가진 기본 클래스에는 반드시 가상 소멸자를 선언해야 한다. 즉, 어떤 클래스가 가상 함수를 하나라도 갖고 있으면, 이 클래스의 소멸자도 가상 소멸자이어야 한다.**
- **기본 클래스로 설계되지 않았거나 다형성을 갖도록 설계되지 않은 클래스에는 가상 소멸자를 선언하지 말아야 한다.**